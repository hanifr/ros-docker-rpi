<!-- physics_tuner.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Robot Physics Parameter Tuner</title>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            color: #ffffff;
            margin: 0;
            padding: 0;
            min-height: 100vh;
        }
        .physics-tuner {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .parameter-panel {
            background: #1f4162;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #dee2e6;
        }
        
        .logging-panel {
            background: #1f4162;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #007bff;
        }
        
        .chart-panel {
            background: #b3d6f1;
            padding: 15px;
            border-radius: 8px;
            border: 2px solid #28a745;
        }
        
        .param-control {
            margin: 15px 0;
            padding: 10px;
            background: #1f4162;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        
        .slider-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .param-slider {
            flex: 1;
            height: 25px;
        }
        
        .param-value {
            min-width: 60px;
            text-align: center;
            font-weight: bold;
            background: #1f4162;
            padding: 5px;
            border-radius: 3px;
        }
        
        .test-button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .test-movement { background: #17a2b8; color: white; }
        .test-physics { background: #28a745; color: white; }
        .reset-params { background: #ffc107; color: black; }
        .publish-params { background: #dc3545; color: white; }
        .logging-btn { background: #007bff; color: white; }
        .stop-btn { background: #dc3545; color: white; }
        .export-btn { background: #6f42c1; color: white; }
        
        .physics-result {
            background: #1f4162;
            border: 1px solid #c3e6cb;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .status-indicator {
            padding: 8px 12px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        
        .status-connected {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }
        
        .metric-card {
            background: white;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #ccc;
        }
        
        .metric-value {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        
        .metric-label {
            font-size: 0.85em;
            color: #666;
        }
        
        .chart-container {
            position: relative;
            height: 250px;
            margin: 15px 0;
        }
        
        .analysis-results {
            font-family: monospace;
            font-size: 12px;
            background: rgb(58, 56, 56);
            padding: 10px;
            border: 1px solid #ccc;
            height: 120px;
            overflow-y: scroll;
            margin: 10px 0;
        }
        
        .full-width {
            grid-column: 1 / -1;
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

    <!-- Navigation Component -->
    <nav id="interface-navigation" style="
        background: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(10px);
        border-bottom: 2px solid #007acc;
        padding: 0.75rem 1rem;
        position: sticky;
        top: 0;
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 1rem;
    ">
        <!-- Logo/Title -->
        <div style="
            font-size: 1.2rem;
            font-weight: bold;
            background: linear-gradient(45deg, #007acc, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: #007acc;
        ">
            ü§ñ ROS 2 Platform
        </div>
        
        <!-- Navigation Links -->
        <div id="nav-links" style="
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        ">
            <a href="/" class="nav-link" data-interface="dashboard" style="
                padding: 0.5rem 0.8rem;
                background: rgba(0, 122, 204, 0.2);
                border: 1px solid rgba(0, 122, 204, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(0, 122, 204, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(0, 122, 204, 0.2)'; this.style.transform='translateY(0)'">
                üè† <span class="nav-text">Dashboard</span>
            </a>
            
            <!-- <a href="/control" class="nav-link" data-interface="control" style="
                padding: 0.5rem 0.8rem;
                background: rgba(0, 122, 204, 0.2);
                border: 1px solid rgba(0, 122, 204, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(0, 122, 204, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(0, 122, 204, 0.2)'; this.style.transform='translateY(0)'">
                üéÆ <span class="nav-text">Control</span>
            </a> -->
            
            <a href="/physics" class="nav-link" data-interface="physics" style="
                padding: 0.5rem 0.8rem;
                background: rgba(0, 122, 204, 0.2);
                border: 1px solid rgba(0, 122, 204, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(0, 122, 204, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(0, 122, 204, 0.2)'; this.style.transform='translateY(0)'">
                ‚öôÔ∏è <span class="nav-text">Physics</span>
            </a>
            
            <!-- <a href="/data" class="nav-link" data-interface="data" style="
                padding: 0.5rem 0.8rem;
                background: rgba(0, 122, 204, 0.2);
                border: 1px solid rgba(0, 122, 204, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(0, 122, 204, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(0, 122, 204, 0.2)'; this.style.transform='translateY(0)'">
                üìä <span class="nav-text">Data</span>
            </a> -->
            
            <!-- <a href="/quality" class="nav-link" data-interface="quality" style="
                padding: 0.5rem 0.8rem;
                background: rgba(0, 122, 204, 0.2);
                border: 1px solid rgba(0, 122, 204, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(0, 122, 204, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(0, 122, 204, 0.2)'; this.style.transform='translateY(0)'">
                üî¨ <span class="nav-text">Quality</span>
            </a> -->
            
            <a href="/material" class="nav-link" data-interface="material" style="
                padding: 0.5rem 0.8rem;
                background: rgba(0, 122, 204, 0.2);
                border: 1px solid rgba(0, 122, 204, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(0, 122, 204, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(0, 122, 204, 0.2)'; this.style.transform='translateY(0)'">
                üì¶ <span class="nav-text">Material</span>
            </a>
            
            <a href="/amh-excel" class="nav-link" data-interface="excel" style="
                padding: 0.5rem 0.8rem;
                background: rgba(0, 122, 204, 0.2);
                border: 1px solid rgba(0, 122, 204, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(0, 122, 204, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(0, 122, 204, 0.2)'; this.style.transform='translateY(0)'">
                üìà <span class="nav-text">Excel</span>
            </a>
            
            <a href="/advanced" class="nav-link" data-interface="advanced" style="
                padding: 0.5rem 0.8rem;
                background: rgba(255, 165, 0, 0.2);
                border: 1px solid rgba(255, 165, 0, 0.3);
                border-radius: 5px;
                color: #ffffff;
                text-decoration: none;
                font-size: 0.85rem;
                display: flex;
                align-items: center;
                gap: 0.3rem;
                transition: all 0.2s ease;
                white-space: nowrap;
            " onmouseover="this.style.background='rgba(255, 165, 0, 0.4)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='rgba(255, 165, 0, 0.2)'; this.style.transform='translateY(0)'">
                üöÄ <span class="nav-text">Advanced</span>
            </a>
        </div>
        
        <!-- Status Indicator -->
        <div id="nav-status" style="
            padding: 0.3rem 0.6rem;
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.3);
            border-radius: 15px;
            font-size: 0.75rem;
            color: #90ee90;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        ">
            üü¢ <span id="nav-status-text">Online</span>
        </div>
    </nav>

    <div class="physics-tuner">
        <h1>üöÄ Robot Physics Parameter Tuner</h1>
        <p><em>Real-time physics tuning with data logging and visualization</em></p>
        
        <!-- Connection Status -->
        <div id="connection-status" class="status-indicator status-disconnected">
            üî¥ Connecting to ROS...
        </div>
        
        <!-- Parameter Control & Logging Section -->
        <div class="main-grid">
            <!-- Parameter Publishing Panel -->
            <div class="parameter-panel">
                <h3>üì° Parameter Server Control</h3>
                <p>Configure and publish physics parameters to ROS.</p>
                <div>
                    <button class="test-button publish-params" onclick="publishAllParameters()">üì§ Publish Parameters</button>
                    <button class="test-button test-physics" onclick="readParametersFromServer()">üì• Read from Server</button>
                    <button class="test-button reset-params" onclick="resetToDefaults()">üîÑ Reset Defaults</button>
                </div>
                <div id="param-status">
                    <small><em>Parameters not yet published to ROS</em></small>
                </div>
            </div>
            
            <!-- Data Logging Control -->
            <div class="logging-panel">
                <h3>üìä Physics Data Logging</h3>
                <p>Capture and analyze real-time physics simulation data.</p>
                <div>
                    <button class="test-button logging-btn" onclick="startLogging()">üéØ Start Logging</button>
                    <button class="test-button stop-btn" onclick="stopLogging()">‚èπÔ∏è Stop Logging</button>
                    <button class="test-button export-btn" onclick="exportPhysicsData()">üíæ Export Data</button>
                    <button class="test-button reset-params" onclick="clearLogs()">üóëÔ∏è Clear Logs</button>
                </div>
                <p><strong>Status:</strong> <span id="logging-status">Stopped</span></p>
                <p><strong>Data Points:</strong> <span id="data-count">0</span></p>
            </div>
        </div>
        
        <!-- Physics Parameters Grid -->
        <div class="main-grid">
            <!-- Motion Parameters -->
            <div class="parameter-panel">
                <h3>üöó Motion Parameters</h3>
                
                <div class="param-control">
                    <label><strong>Max Linear Velocity (m/s)</strong></label>
                    <div class="slider-container">
                        <input type="range" class="param-slider" id="max-linear-vel" 
                               min="0.1" max="3.0" step="0.1" value="0.5" 
                               oninput="updateParameter('max-linear-vel')">
                        <span class="param-value" id="max-linear-vel-value">0.5</span>
                    </div>
                    <small>ROS param: <code>/robot/max_linear_velocity</code></small>
                </div>
                
                <div class="param-control">
                    <label><strong>Max Angular Velocity (rad/s)</strong></label>
                    <div class="slider-container">
                        <input type="range" class="param-slider" id="max-angular-vel" 
                               min="0.1" max="3.0" step="0.1" value="1.0" 
                               oninput="updateParameter('max-angular-vel')">
                        <span class="param-value" id="max-angular-vel-value">1.0</span>
                    </div>
                    <small>ROS param: <code>/robot/max_angular_velocity</code></small>
                </div>
                
                <div class="param-control">
                    <label><strong>Acceleration Limit (m/s¬≤)</strong></label>
                    <div class="slider-container">
                        <input type="range" class="param-slider" id="acceleration-limit" 
                               min="0.1" max="2.0" step="0.1" value="1.0" 
                               oninput="updateParameter('acceleration-limit')">
                        <span class="param-value" id="acceleration-limit-value">1.0</span>
                    </div>
                    <small>ROS param: <code>/robot/acceleration_limit</code></small>
                </div>
            </div>
            
            <!-- Physics Properties -->
            <div class="parameter-panel">
                <h3>‚öôÔ∏è Physics Properties</h3>
                
                <div class="param-control">
                    <label><strong>Robot Mass (kg)</strong></label>
                    <div class="slider-container">
                        <input type="range" class="param-slider" id="robot-mass" 
                               min="1" max="100" step="1" value="15" 
                               oninput="updateParameter('robot-mass')">
                        <span class="param-value" id="robot-mass-value">15</span>
                    </div>
                    <small>ROS param: <code>/robot/mass</code></small>
                </div>
                
                <div class="param-control">
                    <label><strong>Wheel Friction Coefficient</strong></label>
                    <div class="slider-container">
                        <input type="range" class="param-slider" id="friction-coeff" 
                               min="0.1" max="2.0" step="0.1" value="1.0" 
                               oninput="updateParameter('friction-coeff')">
                        <span class="param-value" id="friction-coeff-value">1.0</span>
                    </div>
                    <small>ROS param: <code>/robot/wheel_friction</code></small>
                </div>
                
                <div class="param-control">
                    <label><strong>Damping Factor</strong></label>
                    <div class="slider-container">
                        <input type="range" class="param-slider" id="damping-factor" 
                               min="0.0" max="1.0" step="0.05" value="0.2" 
                               oninput="updateParameter('damping-factor')">
                        <span class="param-value" id="damping-factor-value">0.2</span>
                    </div>
                    <small>ROS param: <code>/robot/damping_factor</code></small>
                </div>
            </div>
        </div>
        
        <!-- Real-time Metrics -->
        <div class="parameter-panel full-width">
            <h3>üìà Real-time Physics Metrics</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="current-linear">0.000</div>
                    <div class="metric-label">Linear Vel (m/s)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="current-angular">0.000</div>
                    <div class="metric-label">Angular Vel (rad/s)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="kinetic-energy">0.00</div>
                    <div class="metric-label">Kinetic Energy (J)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="current-x">0.000</div>
                    <div class="metric-label">Position X (m)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="current-y">0.000</div>
                    <div class="metric-label">Position Y (m)</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="acceleration">0.000</div>
                    <div class="metric-label">Acceleration (m/s¬≤)</div>
                </div>
            </div>
        </div>
        
        <!-- Physics Testing Panel -->
        <div class="parameter-panel full-width">
            <h3>üß™ Physics Testing</h3>
            <div>
                <button class="test-button test-movement" onclick="testLinearMovement()">üèÉ Test Linear</button>
                <button class="test-button test-movement" onclick="testAngularMovement()">üîÑ Test Turning</button>
                <button class="test-button test-physics" onclick="testAcceleration()">‚ö° Test Acceleration</button>
                <button class="test-button test-physics" onclick="testDeceleration()">üõë Test Stopping</button>
                <button class="test-button publish-params" onclick="emergencyStop()">üö® Emergency Stop</button>
            </div>
            
            <div id="test-results">
                <div class="physics-result">
                    <strong>Ready for testing</strong> - Adjust parameters above and click test buttons
                </div>
            </div>
        </div>
        
        <!-- Data Visualization Charts -->
        <div class="charts-grid">
            <!-- Trajectory Chart -->
            <div class="chart-panel">
                <h3>üó∫Ô∏è Robot Trajectory</h3>
                <div class="chart-container">
                    <canvas id="trajectoryChart"></canvas>
                </div>
            </div>
            
            <!-- Velocity Profile Chart -->
            <div class="chart-panel">
                <h3>üìà Velocity Profile</h3>
                <div class="chart-container">
                    <canvas id="velocityChart"></canvas>
                </div>
            </div>
            
            <!-- Energy Analysis Chart -->
            <div class="chart-panel">
                <h3>‚ö° Energy Analysis</h3>
                <div class="chart-container">
                    <canvas id="energyChart"></canvas>
                </div>
            </div>
            
            <!-- Physics Analysis -->
            <div class="chart-panel">
                <h3>üî¨ Physics Analysis</h3>
                <div class="analysis-results" id="analysis-results">
                    Physics analysis will appear here when logging is active...
                </div>
                <div>
                    <button class="test-button logging-btn" onclick="performPhysicsAnalysis()">üîç Analyze Now</button>
                    <button class="test-button export-btn" onclick="exportAnalysisReport()">üìã Export Report</button>
                </div>
            </div>
        </div>
        
        <!-- Parameter Summary -->
        <div class="parameter-panel full-width">
            <h3>üìã Current Parameter Summary</h3>
            <div id="parameter-summary" style="font-family: monospace; background: #1f4162; padding: 15px; border-radius: 5px;">
                <!-- Parameter summary will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // ROS connection
        var ros = new ROSLIB.Ros({
            url: 'ws://' + window.location.hostname + ':9090'
            // url: 'ws://192.168.1.104:9090'
        });
        
        // Physics data storage
        var physicsData = [];
        var isLogging = false;
        var startTime = Date.now();
        var lastPosition = {x: 0, y: 0};
        var lastVelocity = {linear: 0, angular: 0};
        var physicsStepCount = 0;
        
        // Connection status handling
        ros.on('connection', function() {
            console.log('Connected to ROS!');
            document.getElementById('connection-status').className = 'status-indicator status-connected';
            document.getElementById('connection-status').innerHTML = 'üü¢ Connected to ROS';
            document.getElementById('nav-status-text').textContent = 'Online';
            
            setTimeout(readParametersFromServer, 1000);
        });
        
        ros.on('error', function(error) {
            console.log('ROS connection error: ', error);
            document.getElementById('connection-status').className = 'status-indicator status-disconnected';
            document.getElementById('connection-status').innerHTML = 'üî¥ ROS Connection Error';
            document.getElementById('nav-status-text').textContent = 'Error';
        });
        
        ros.on('close', function() {
            console.log('ROS connection closed');
            document.getElementById('connection-status').className = 'status-indicator status-disconnected';
            document.getElementById('connection-status').innerHTML = 'üü° ROS Connection Closed';
            document.getElementById('nav-status-text').textContent = 'Offline';
        });
        
        // Current physics parameters
        var physicsParams = {
            maxLinearVel: 0.5,
            maxAngularVel: 1.0,
            accelerationLimit: 1.0,
            robotMass: 15,
            frictionCoeff: 1.0,
            dampingFactor: 0.2
        };
        
        // ROS topics
        var cmdVel = new ROSLIB.Topic({
            ros: ros,
            name: '/cmd_vel',
            messageType: 'geometry_msgs/Twist'
        });
        
        var odomSubscriber = new ROSLIB.Topic({
            ros: ros,
            name: '/odom',
            messageType: 'nav_msgs/Odometry'
        });
        
        // Chart setup
        var trajectoryChart = new Chart(document.getElementById('trajectoryChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Robot Path',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    showLine: true,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'X Position (m)' }},
                    y: { title: { display: true, text: 'Y Position (m)' }}
                }
            }
        });
        
        var velocityChart = new Chart(document.getElementById('velocityChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Linear Velocity',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: false
                }, {
                    label: 'Angular Velocity',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Time (s)' }},
                    y: { title: { display: true, text: 'Velocity' }}
                }
            }
        });
        
        var energyChart = new Chart(document.getElementById('energyChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Kinetic Energy (J)',
                    data: [],
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Time (s)' }},
                    y: { title: { display: true, text: 'Energy (J)' }}
                }
            }
        });
        
        // Monitor robot state and log data
        odomSubscriber.subscribe(function(message) {
            try {
                var currentTime = (Date.now() - startTime) / 1000;
                physicsStepCount++;
                
                // Extract physics data
                var position = {
                    x: message.pose.pose.position.x,
                    y: message.pose.pose.position.y
                };
                
                var linearVel = Math.sqrt(
                    Math.pow(message.twist.twist.linear.x, 2) + 
                    Math.pow(message.twist.twist.linear.y, 2)
                );
                var angularVel = Math.abs(message.twist.twist.angular.z);
                
                // Calculate physics metrics
                var kineticEnergy = 0.5 * physicsParams.robotMass * (linearVel * linearVel);
                
                // Calculate acceleration
                var acceleration = 0;
                if (physicsData.length > 0) {
                    var lastData = physicsData[physicsData.length - 1];
                    var dt = currentTime - lastData.time;
                    if (dt > 0) {
                        acceleration = (linearVel - lastData.velocity) / dt;
                    }
                }
                
                // Update real-time display
                document.getElementById('current-x').textContent = position.x.toFixed(3);
                document.getElementById('current-y').textContent = position.y.toFixed(3);
                document.getElementById('current-linear').textContent = linearVel.toFixed(3);
                document.getElementById('current-angular').textContent = angularVel.toFixed(3);
                document.getElementById('kinetic-energy').textContent = kineticEnergy.toFixed(2);
                document.getElementById('acceleration').textContent = acceleration.toFixed(3);
                
                // Store data if logging
                if (isLogging) {
                    var dataPoint = {
                        time: currentTime,
                        position_x: position.x,
                        position_y: position.y,
                        velocity: linearVel,
                        angular_velocity: angularVel,
                        acceleration: acceleration,
                        kinetic_energy: kineticEnergy,
                        physics_step: physicsStepCount
                    };
                    
                    physicsData.push(dataPoint);
                    document.getElementById('data-count').textContent = physicsData.length;
                    
                    // Update charts
                    updatePhysicsCharts();
                    
                    // Physics analysis every 20 data points
                    if (physicsData.length % 20 === 0) {
                        performPhysicsAnalysis();
                    }
                }
                
                lastPosition = position;
                lastVelocity = {linear: linearVel, angular: angularVel};
                
            } catch (e) {
                console.log('Error processing odometry:', e);
            }
        });
        
        function updateParameter(paramId) {
            var slider = document.getElementById(paramId);
            var valueDisplay = document.getElementById(paramId + '-value');
            var value = parseFloat(slider.value);
            
            valueDisplay.textContent = value.toFixed(2);
            
            // Update internal parameters
            switch(paramId) {
                case 'max-linear-vel':
                    physicsParams.maxLinearVel = value;
                    break;
                case 'max-angular-vel':
                    physicsParams.maxAngularVel = value;
                    break;
                case 'acceleration-limit':
                    physicsParams.accelerationLimit = value;
                    break;
                case 'robot-mass':
                    physicsParams.robotMass = value;
                    break;
                case 'friction-coeff':
                    physicsParams.frictionCoeff = value;
                    break;
                case 'damping-factor':
                    physicsParams.dampingFactor = value;
                    break;
            }
            
            updateParameterSummary();
            console.log('Updated parameter:', paramId, '=', value);
        }
        
        function updateParameterSummary() {
            var summary = `
Robot Physics Parameters:
‚îú‚îÄ Motion
‚îÇ  ‚îú‚îÄ Max Linear Velocity: ${physicsParams.maxLinearVel} m/s
‚îÇ  ‚îú‚îÄ Max Angular Velocity: ${physicsParams.maxAngularVel} rad/s
‚îÇ  ‚îî‚îÄ Acceleration Limit: ${physicsParams.accelerationLimit} m/s¬≤
‚îÇ
‚îî‚îÄ Physics
   ‚îú‚îÄ Mass: ${physicsParams.robotMass} kg
   ‚îú‚îÄ Wheel Friction: ${physicsParams.frictionCoeff}
   ‚îî‚îÄ Damping Factor: ${physicsParams.dampingFactor}
            `.trim();
            
            document.getElementById('parameter-summary').textContent = summary;
        }
        
        function startLogging() {
            isLogging = true;
            physicsData = [];
            startTime = Date.now();
            physicsStepCount = 0;
            document.getElementById('logging-status').textContent = 'Recording';
            document.getElementById('logging-status').style.color = 'green';
            addAnalysisResult('Physics data logging started');
        }
        
        function stopLogging() {
            isLogging = false;
            document.getElementById('logging-status').textContent = 'Stopped';
            document.getElementById('logging-status').style.color = 'red';
            addAnalysisResult(`Logging stopped. ${physicsData.length} data points collected.`);
        }
        
        function updatePhysicsCharts() {
            if (physicsData.length === 0) return;
            
            // Update trajectory chart (last 100 points)
            var trajectoryData = physicsData.slice(-100).map(d => ({x: d.position_x, y: d.position_y}));
            trajectoryChart.data.datasets[0].data = trajectoryData;
            trajectoryChart.update('none');
            
            // Update velocity chart (last 50 points)
            var recentData = physicsData.slice(-50);
            velocityChart.data.labels = recentData.map(d => d.time.toFixed(1));
            velocityChart.data.datasets[0].data = recentData.map(d => d.velocity);
            velocityChart.data.datasets[1].data = recentData.map(d => d.angular_velocity);
            velocityChart.update('none');
            
            // Update energy chart
            energyChart.data.labels = recentData.map(d => d.time.toFixed(1));
            energyChart.data.datasets[0].data = recentData.map(d => d.kinetic_energy);
            energyChart.update('none');
        }
        
        function performPhysicsAnalysis() {
            if (physicsData.length < 10) return;
            
            var recent = physicsData.slice(-10);
            var avgVelocity = recent.reduce((sum, d) => sum + d.velocity, 0) / recent.length;
            var maxVelocity = Math.max(...recent.map(d => d.velocity));
            var energyVariation = Math.max(...recent.map(d => d.kinetic_energy)) - 
                                 Math.min(...recent.map(d => d.kinetic_energy));
            
            // Check for physics anomalies
            if (maxVelocity > physicsParams.maxLinearVel * 1.1) {
                addAnalysisResult('‚ö†Ô∏è Velocity exceeds limit: ' + maxVelocity.toFixed(2) + ' m/s');
            }
            
            if (energyVariation > 20) {
                addAnalysisResult('‚ö†Ô∏è Large energy variation: ' + energyVariation.toFixed(2) + ' J');
            }
            
            // Physics validation
            var expectedKE = 0.5 * physicsParams.robotMass * avgVelocity * avgVelocity;
            var actualKE = recent[recent.length-1].kinetic_energy;
            var error = Math.abs(expectedKE - actualKE) / Math.max(expectedKE, 0.001) * 100;
            
            if (error > 5) {
                addAnalysisResult('‚ö†Ô∏è Physics error: ' + error.toFixed(1) + '%');
            } else {
                addAnalysisResult('‚úì Physics validation OK (error: ' + error.toFixed(1) + '%)');
            }
        }
        
        function addAnalysisResult(message) {
            var timestamp = new Date().toLocaleTimeString();
            var resultsDiv = document.getElementById('analysis-results');
            resultsDiv.textContent += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            // Keep only last 20 lines
            var lines = resultsDiv.textContent.split('\n');
            if (lines.length > 20) {
                resultsDiv.textContent = lines.slice(-20).join('\n');
            }
        }
        
        function exportPhysicsData() {
            if (physicsData.length === 0) {
                alert('No physics data to export. Start logging first.');
                return;
            }
            
            var csvContent = "time,position_x,position_y,velocity,angular_velocity,acceleration,kinetic_energy,physics_step\n";
            physicsData.forEach(function(d) {
                csvContent += `${d.time},${d.position_x},${d.position_y},${d.velocity},${d.angular_velocity},${d.acceleration},${d.kinetic_energy},${d.physics_step}\n`;
            });
            
            downloadCSV(csvContent, 'physics_tuning_data.csv');
            addAnalysisResult(`Data exported: ${physicsData.length} points`);
        }
        
        function exportAnalysisReport() {
            var reportContent = "Physics Analysis Report\n";
            reportContent += "Generated: " + new Date().toLocaleString() + "\n\n";
            reportContent += "Current Parameters:\n";
            reportContent += Object.keys(physicsParams).map(key => 
                `${key}: ${physicsParams[key]}`).join('\n');
            reportContent += "\n\nAnalysis Log:\n";
            reportContent += document.getElementById('analysis-results').textContent;
            
            downloadCSV(reportContent, 'physics_analysis_report.txt');
        }
        
        function downloadCSV(content, filename) {
            var blob = new Blob([content], { type: 'text/plain' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function clearLogs() {
            physicsData = [];
            trajectoryChart.data.datasets[0].data = [];
            velocityChart.data.labels = [];
            velocityChart.data.datasets[0].data = [];
            velocityChart.data.datasets[1].data = [];
            energyChart.data.labels = [];
            energyChart.data.datasets[0].data = [];
            
            trajectoryChart.update();
            velocityChart.update();
            energyChart.update();
            
            document.getElementById('data-count').textContent = '0';
            document.getElementById('analysis-results').textContent = 'Physics analysis cleared...\n';
            addAnalysisResult('Data logs cleared');
        }
        
        // Original physics tuner functions
        function publishAllParameters() {
            addTestResult('Publishing all parameters to ROS Parameter Server...');
            
            var params = [
                {name: '/robot/max_linear_velocity', value: physicsParams.maxLinearVel},
                {name: '/robot/max_angular_velocity', value: physicsParams.maxAngularVel},
                {name: '/robot/acceleration_limit', value: physicsParams.accelerationLimit},
                {name: '/robot/mass', value: physicsParams.robotMass},
                {name: '/robot/wheel_friction', value: physicsParams.frictionCoeff},
                {name: '/robot/damping_factor', value: physicsParams.dampingFactor}
            ];
            
            var publishCount = 0;
            var totalParams = params.length;
            
            params.forEach(function(param) {
                var rosParam = new ROSLIB.Param({
                    ros: ros,
                    name: param.name
                });
                
                rosParam.set(param.value, function(result) {
                    publishCount++;
                    console.log('Published parameter:', param.name, '=', param.value);
                    
                    if (publishCount === totalParams) {
                        addTestResult(`‚úÖ Successfully published ${totalParams} parameters to ROS`);
                        document.getElementById('param-status').innerHTML = 
                            '<small><em>‚úÖ Parameters published to ROS Parameter Server</em></small>';
                    }
                });
            });
        }
        
        function readParametersFromServer() {
            addTestResult('Reading parameters from ROS Parameter Server...');
            
            var params = [
                {name: '/robot/max_linear_velocity', id: 'max-linear-vel'},
                {name: '/robot/max_angular_velocity', id: 'max-angular-vel'},
                {name: '/robot/acceleration_limit', id: 'acceleration-limit'},
                {name: '/robot/mass', id: 'robot-mass'},
                {name: '/robot/wheel_friction', id: 'friction-coeff'},
                {name: '/robot/damping_factor', id: 'damping-factor'}
            ];
            
            var readCount = 0;
            var foundParams = 0;
            
            params.forEach(function(param) {
                var rosParam = new ROSLIB.Param({
                    ros: ros,
                    name: param.name
                });
                
                rosParam.get(function(value) {
                    readCount++;
                    if (value !== null && value !== undefined) {
                        foundParams++;
                        document.getElementById(param.id).value = value;
                        updateParameter(param.id);
                    }
                    
                    if (readCount === params.length) {
                        if (foundParams > 0) {
                            addTestResult(`‚úÖ Read ${foundParams} parameters from ROS`);
                        } else {
                            addTestResult('‚ö†Ô∏è No parameters found on ROS Parameter Server');
                        }
                    }
                }, function(error) {
                    readCount++;
                    if (readCount === params.length) {
                        addTestResult('‚ö†Ô∏è Some parameters not found on server');
                    }
                });
            });
        }
        
        function testLinearMovement() {
            addTestResult(`Testing linear movement at ${physicsParams.maxLinearVel} m/s...`);
            
            var twist = new ROSLIB.Message({
                linear: { x: physicsParams.maxLinearVel, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: 0 }
            });
            cmdVel.publish(twist);
            
            setTimeout(function() {
                stopRobot();
                addTestResult(`‚úÖ Linear test complete. Max velocity: ${physicsParams.maxLinearVel} m/s`);
            }, 3000);
        }
        
        function testAngularMovement() {
            addTestResult(`Testing angular movement at ${physicsParams.maxAngularVel} rad/s...`);
            
            var twist = new ROSLIB.Message({
                linear: { x: 0, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: physicsParams.maxAngularVel }
            });
            cmdVel.publish(twist);
            
            setTimeout(function() {
                stopRobot();
                addTestResult(`‚úÖ Angular test complete. Max angular velocity: ${physicsParams.maxAngularVel} rad/s`);
            }, 2000);
        }
        
        function testAcceleration() {
            addTestResult('Testing acceleration profile...');
            
            var targetVel = physicsParams.maxLinearVel;
            var accelLimit = physicsParams.accelerationLimit;
            var timeToTarget = targetVel / accelLimit;
            var steps = 20;
            var stepTime = (timeToTarget * 1000) / steps;
            var velIncrement = targetVel / steps;
            
            var currentVel = 0;
            var step = 0;
            
            var accelInterval = setInterval(function() {
                currentVel = Math.min(currentVel + velIncrement, targetVel);
                
                var twist = new ROSLIB.Message({
                    linear: { x: currentVel, y: 0, z: 0 },
                    angular: { x: 0, y: 0, z: 0 }
                });
                cmdVel.publish(twist);
                
                step++;
                if (step >= steps) {
                    clearInterval(accelInterval);
                    setTimeout(function() {
                        stopRobot();
                        addTestResult(`‚úÖ Acceleration test complete. Time to max speed: ${timeToTarget.toFixed(1)}s`);
                    }, 1000);
                }
            }, stepTime);
        }
        
        function testDeceleration() {
            addTestResult('Testing deceleration and stopping...');
            
            var twist = new ROSLIB.Message({
                linear: { x: physicsParams.maxLinearVel, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: 0 }
            });
            cmdVel.publish(twist);
            
            setTimeout(function() {
                stopRobot();
                var stoppingTime = physicsParams.maxLinearVel / physicsParams.accelerationLimit;
                var dampingEffect = (1 - physicsParams.dampingFactor) * 2;
                var totalStopTime = stoppingTime + dampingEffect;
                
                addTestResult(`‚úÖ Deceleration test complete. Estimated stopping time: ${totalStopTime.toFixed(1)}s`);
            }, 1500);
        }
        
        function emergencyStop() {
            stopRobot();
            addTestResult('üö® Emergency stop activated');
        }
        
        function resetToDefaults() {
            document.getElementById('max-linear-vel').value = 0.5;
            document.getElementById('max-angular-vel').value = 1.0;
            document.getElementById('acceleration-limit').value = 1.0;
            document.getElementById('robot-mass').value = 15;
            document.getElementById('friction-coeff').value = 1.0;
            document.getElementById('damping-factor').value = 0.2;
            
            ['max-linear-vel', 'max-angular-vel', 'acceleration-limit', 
             'robot-mass', 'friction-coeff', 'damping-factor'].forEach(function(id) {
                updateParameter(id);
            });
            
            addTestResult('Parameters reset to default values');
        }
        
        function stopRobot() {
            var twist = new ROSLIB.Message({
                linear: { x: 0, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: 0 }
            });
            cmdVel.publish(twist);
        }
        
        function addTestResult(message) {
            var resultsDiv = document.getElementById('test-results');
            var timestamp = new Date().toLocaleTimeString();
            var resultElement = document.createElement('div');
            resultElement.className = 'physics-result';
            resultElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            resultsDiv.appendChild(resultElement);
            
            // Keep only last 5 results
            while (resultsDiv.children.length > 5) {
                resultsDiv.removeChild(resultsDiv.firstChild);
            }
            
            // Also add to analysis log
            addAnalysisResult(message);
        }
        
        // Initialize all parameter displays
        ['max-linear-vel', 'max-angular-vel', 'acceleration-limit', 
         'robot-mass', 'friction-coeff', 'damping-factor'].forEach(function(id) {
            updateParameter(id);
        });
        
        // Initialize parameter summary
        updateParameterSummary();
        
        // Initialize analysis
        addAnalysisResult('Enhanced Physics Tuner initialized');
    </script>
</body>
</html>

<!-- physics_tuner.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Physics Parameter Tuner - Corporate Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/roslib@1/build/roslib.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #60a5fa;
            --secondary-blue: #3b82f6;
            --accent-blue: #93c5fd;
            --light-blue: #1e40af;
            --dark-background: #0f172a;
            --card-background: #1e293b;
            --panel-background: #334155;
            --surface-background: #475569;
            --success-green: #22c55e;
            --warning-amber: #fbbf24;
            --error-red: #f87171;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --border-light: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.4);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--dark-background);
            color: var(--text-primary);
            line-height: 1.6;
            font-size: 14px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1.5rem 2rem;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 2rem;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, var(--primary-blue), var(--secondary-blue));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .header-info h1 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .header-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Navigation */
        .nav-links {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .nav-link {
            padding: 0.5rem 0.8rem;
            background: rgba(96, 165, 250, 0.1);
            border: 1px solid rgba(96, 165, 250, 0.2);
            border-radius: 6px;
            color: var(--text-primary);
            text-decoration: none;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(96, 165, 250, 0.2);
            border-color: var(--primary-blue);
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .nav-link.active {
            background: linear-gradient(135deg, var(--secondary-blue), var(--light-blue));
            border-color: var(--primary-blue);
            box-shadow: var(--shadow-md);
        }

        .nav-link.advanced {
            background: rgba(251, 191, 36, 0.1);
            border-color: rgba(251, 191, 36, 0.2);
        }

        .nav-link.advanced:hover {
            background: rgba(251, 191, 36, 0.2);
            border-color: var(--warning-amber);
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .status-online {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-green);
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .status-offline {
            background: rgba(248, 113, 113, 0.1);
            color: var(--error-red);
            border: 1px solid rgba(248, 113, 113, 0.2);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Main Content */
        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .panel {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .panel-header {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border-color);
            background: var(--panel-background);
        }

        .panel-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .panel-content {
            padding: 1.5rem 2rem;
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 1.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        /* Parameter Controls */
        .param-control {
            margin: 1rem 0;
            padding: 1rem;
            background: var(--surface-background);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .param-control label {
            display: block;
            margin-bottom: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .slider-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .param-slider {
            flex: 1;
            height: 6px;
            background: var(--panel-background);
            border-radius: 3px;
            outline: none;
            appearance: none;
        }

        .param-slider::-webkit-slider-thumb {
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-blue);
            cursor: pointer;
            box-shadow: var(--shadow-sm);
        }

        .param-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--secondary-blue);
            cursor: pointer;
            border: none;
        }

        .param-value {
            min-width: 80px;
            text-align: center;
            font-weight: 600;
            background: var(--panel-background);
            padding: 0.5rem;
            border-radius: 6px;
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .param-control small {
            color: var(--text-muted);
            font-size: 0.75rem;
        }

        .param-control small code {
            background: var(--panel-background);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', monospace;
            border: 1px solid var(--border-color);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.875rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.25rem;
        }

        .btn-primary {
            background: var(--secondary-blue);
            color: white;
        }

        .btn-primary:hover {
            background: var(--light-blue);
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-success {
            background: var(--success-green);
            color: white;
        }

        .btn-success:hover {
            background: #16a34a;
            transform: translateY(-1px);
        }

        .btn-warning {
            background: var(--warning-amber);
            color: #1f2937;
        }

        .btn-warning:hover {
            background: #f59e0b;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--error-red);
            color: white;
        }

        .btn-danger:hover {
            background: #ef4444;
            transform: translateY(-1px);
        }

        .btn-purple {
            background: #8b5cf6;
            color: white;
        }

        .btn-purple:hover {
            background: #7c3aed;
            transform: translateY(-1px);
        }

        /* Status Indicators */
        .status {
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            font-weight: 500;
            font-size: 0.875rem;
            border-left: 4px solid;
        }

        .status.connected {
            background: rgba(34, 197, 94, 0.1);
            color: var(--success-green);
            border-left-color: var(--success-green);
        }

        .status.disconnected {
            background: rgba(248, 113, 113, 0.1);
            color: var(--error-red);
            border-left-color: var(--error-red);
        }

        /* Metrics Grid */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 1rem 0;
        }

        .metric-card {
            background: var(--surface-background);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border-color);
        }

        .metric-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-blue);
            margin-bottom: 0.25rem;
            font-family: 'Monaco', 'Menlo', monospace;
        }

        .metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.025em;
        }

        /* Charts */
        .chart-container {
            position: relative;
            height: 250px;
            margin: 1rem 0;
            background: var(--surface-background);
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid var(--border-color);
        }

        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin: 2rem 0;
        }

        .chart-panel {
            background: var(--card-background);
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        /* Analysis Results */
        .analysis-results {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.75rem;
            background: var(--surface-background);
            padding: 1rem;
            border: 1px solid var(--border-color);
            height: 150px;
            overflow-y: auto;
            margin: 1rem 0;
            border-radius: 8px;
            color: var(--success-green);
            line-height: 1.4;
        }

        .analysis-results::-webkit-scrollbar {
            width: 6px;
        }

        .analysis-results::-webkit-scrollbar-track {
            background: var(--card-background);
        }

        .analysis-results::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 3px;
        }

        /* Test Results */
        .physics-result {
            background: var(--surface-background);
            border: 1px solid var(--border-color);
            padding: 1rem;
            margin: 0.5rem 0;
            border-radius: 8px;
            border-left: 4px solid var(--primary-blue);
        }

        /* Parameter Summary */
        .parameter-summary {
            font-family: 'Monaco', 'Menlo', monospace;
            background: var(--surface-background);
            padding: 1.5rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Full Width Panels */
        .full-width {
            grid-column: 1 / -1;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .charts-grid {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .nav-links {
                gap: 0.3rem;
            }

            .nav-link {
                font-size: 0.75rem;
                padding: 0.4rem 0.6rem;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .nav-links {
                justify-content: center;
                gap: 0.3rem;
            }

            .nav-text {
                display: none;
            }

            .nav-link {
                padding: 0.4rem 0.6rem;
                font-size: 0.75rem;
            }

            .main-content {
                padding: 1rem;
            }

            .panel-header,
            .panel-content {
                padding: 1rem;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 200px;
            }
        }

        @media (max-width: 480px) {
            .nav-link {
                padding: 0.3rem 0.5rem;
                font-size: 0.7rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo-section">
                <div class="logo">⚙️</div>
                <div class="header-info">
                    <h1>Physics Parameter Tuner</h1>
                    <p>Real-time Physics Tuning • Data Logging • Visualization</p>
                </div>
            </div>
            
            <!-- Navigation Links -->
            <nav class="nav-links">
                <a href="/" class="nav-link">
                    🏠 <span class="nav-text">Dashboard</span>
                </a>
                <a href="/physics" class="nav-link active">
                    ⚙️ <span class="nav-text">Physics</span>
                </a>
                <a href="/material" class="nav-link">
                    📦 <span class="nav-text">Material</span>
                </a>
                <a href="/amh-excel" class="nav-link">
                    📈 <span class="nav-text">Excel</span>
                </a>
                <a href="/advanced" class="nav-link advanced">
                    🚀 <span class="nav-text">Advanced</span>
                </a>
            </nav>
            
            <div id="connection-status" class="status-badge status-offline">
                <div class="status-indicator"></div>
                <span>Connecting to ROS</span>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <h1 class="page-title">
            <span>🚀</span>
            Enhanced Physics Parameter Tuner
        </h1>
        <p class="page-subtitle">Real-time physics tuning with comprehensive data logging and visualization</p>
        
        <!-- Parameter Control & Logging Section -->
        <div class="main-grid">
            <!-- Parameter Publishing Panel -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>📡</span>
                        Parameter Server Control
                    </h2>
                </div>
                <div class="panel-content">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Configure and publish physics parameters to ROS.</p>
                    <div>
                        <button class="btn btn-danger" onclick="publishAllParameters()">📤 Publish Parameters</button>
                        <button class="btn btn-success" onclick="readParametersFromServer()">📥 Read from Server</button>
                        <button class="btn btn-warning" onclick="resetToDefaults()">🔄 Reset Defaults</button>
                    </div>
                    <div id="param-status" style="margin-top: 1rem;">
                        <small style="color: var(--text-muted);"><em>Parameters not yet published to ROS</em></small>
                    </div>
                </div>
            </div>
            
            <!-- Data Logging Control -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>📊</span>
                        Physics Data Logging
                    </h2>
                </div>
                <div class="panel-content">
                    <p style="margin-bottom: 1rem; color: var(--text-secondary);">Capture and analyze real-time physics simulation data.</p>
                    <div>
                        <button class="btn btn-primary" onclick="startLogging()">🎯 Start Logging</button>
                        <button class="btn btn-danger" onclick="stopLogging()">⏹️ Stop Logging</button>
                        <button class="btn btn-purple" onclick="exportPhysicsData()">💾 Export Data</button>
                        <button class="btn btn-warning" onclick="clearLogs()">🗑️ Clear Logs</button>
                    </div>
                    <div style="margin-top: 1rem;">
                        <p><strong>Status:</strong> <span id="logging-status" style="color: var(--text-secondary);">Stopped</span></p>
                        <p><strong>Data Points:</strong> <span id="data-count" style="color: var(--primary-blue);">0</span></p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Physics Parameters Grid -->
        <div class="main-grid">
            <!-- Motion Parameters -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>🚗</span>
                        Motion Parameters
                    </h2>
                </div>
                <div class="panel-content">
                    <div class="param-control">
                        <label><strong>Max Linear Velocity (m/s)</strong></label>
                        <div class="slider-container">
                            <input type="range" class="param-slider" id="max-linear-vel" 
                                   min="0.1" max="3.0" step="0.1" value="0.5" 
                                   oninput="updateParameter('max-linear-vel')">
                            <span class="param-value" id="max-linear-vel-value">0.5</span>
                        </div>
                        <small>ROS param: <code>/robot/max_linear_velocity</code></small>
                    </div>
                    
                    <div class="param-control">
                        <label><strong>Max Angular Velocity (rad/s)</strong></label>
                        <div class="slider-container">
                            <input type="range" class="param-slider" id="max-angular-vel" 
                                   min="0.1" max="3.0" step="0.1" value="1.0" 
                                   oninput="updateParameter('max-angular-vel')">
                            <span class="param-value" id="max-angular-vel-value">1.0</span>
                        </div>
                        <small>ROS param: <code>/robot/max_angular_velocity</code></small>
                    </div>
                    
                    <div class="param-control">
                        <label><strong>Acceleration Limit (m/s²)</strong></label>
                        <div class="slider-container">
                            <input type="range" class="param-slider" id="acceleration-limit" 
                                   min="0.1" max="2.0" step="0.1" value="1.0" 
                                   oninput="updateParameter('acceleration-limit')">
                            <span class="param-value" id="acceleration-limit-value">1.0</span>
                        </div>
                        <small>ROS param: <code>/robot/acceleration_limit</code></small>
                    </div>
                </div>
            </div>
            
            <!-- Physics Properties -->
            <div class="panel">
                <div class="panel-header">
                    <h2 class="panel-title">
                        <span>⚙️</span>
                        Physics Properties
                    </h2>
                </div>
                <div class="panel-content">
                    <div class="param-control">
                        <label><strong>Robot Mass (kg)</strong></label>
                        <div class="slider-container">
                            <input type="range" class="param-slider" id="robot-mass" 
                                   min="1" max="100" step="1" value="15" 
                                   oninput="updateParameter('robot-mass')">
                            <span class="param-value" id="robot-mass-value">15</span>
                        </div>
                        <small>ROS param: <code>/robot/mass</code></small>
                    </div>
                    
                    <div class="param-control">
                        <label><strong>Wheel Friction Coefficient</strong></label>
                        <div class="slider-container">
                            <input type="range" class="param-slider" id="friction-coeff" 
                                   min="0.1" max="2.0" step="0.1" value="1.0" 
                                   oninput="updateParameter('friction-coeff')">
                            <span class="param-value" id="friction-coeff-value">1.0</span>
                        </div>
                        <small>ROS param: <code>/robot/wheel_friction</code></small>
                    </div>
                    
                    <div class="param-control">
                        <label><strong>Damping Factor</strong></label>
                        <div class="slider-container">
                            <input type="range" class="param-slider" id="damping-factor" 
                                   min="0.0" max="1.0" step="0.05" value="0.2" 
                                   oninput="updateParameter('damping-factor')">
                            <span class="param-value" id="damping-factor-value">0.2</span>
                        </div>
                        <small>ROS param: <code>/robot/damping_factor</code></small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Real-time Metrics -->
        <div class="panel full-width">
            <div class="panel-header">
                <h2 class="panel-title">
                    <span>📈</span>
                    Real-time Physics Metrics
                </h2>
            </div>
            <div class="panel-content">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="current-linear">0.000</div>
                        <div class="metric-label">Linear Vel (m/s)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="current-angular">0.000</div>
                        <div class="metric-label">Angular Vel (rad/s)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="kinetic-energy">0.00</div>
                        <div class="metric-label">Kinetic Energy (J)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="current-x">0.000</div>
                        <div class="metric-label">Position X (m)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="current-y">0.000</div>
                        <div class="metric-label">Position Y (m)</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="acceleration">0.000</div>
                        <div class="metric-label">Acceleration (m/s²)</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Physics Testing Panel -->
        <div class="panel full-width">
            <div class="panel-header">
                <h2 class="panel-title">
                    <span>🧪</span>
                    Physics Testing
                </h2>
            </div>
            <div class="panel-content">
                <div style="margin-bottom: 1.5rem;">
                    <button class="btn btn-primary" onclick="testLinearMovement()">🏃 Test Linear</button>
                    <button class="btn btn-primary" onclick="testAngularMovement()">🔄 Test Turning</button>
                    <button class="btn btn-success" onclick="testAcceleration()">⚡ Test Acceleration</button>
                    <button class="btn btn-success" onclick="testDeceleration()">🛑 Test Stopping</button>
                    <button class="btn btn-danger" onclick="emergencyStop()">🚨 Emergency Stop</button>
                </div>
                
                <div id="test-results">
                    <div class="physics-result">
                        <strong>Ready for testing</strong> - Adjust parameters above and click test buttons
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Data Visualization Charts -->
        <div class="charts-grid">
            <!-- Trajectory Chart -->
            <div class="chart-panel">
                <div class="panel-header">
                    <h3 class="panel-title">🗺️ Robot Trajectory</h3>
                </div>
                <div class="chart-container">
                    <canvas id="trajectoryChart"></canvas>
                </div>
            </div>
            
            <!-- Velocity Profile Chart -->
            <div class="chart-panel">
                <div class="panel-header">
                    <h3 class="panel-title">📈 Velocity Profile</h3>
                </div>
                <div class="chart-container">
                    <canvas id="velocityChart"></canvas>
                </div>
            </div>
            
            <!-- Energy Analysis Chart -->
            <div class="chart-panel">
                <div class="panel-header">
                    <h3 class="panel-title">⚡ Energy Analysis</h3>
                </div>
                <div class="chart-container">
                    <canvas id="energyChart"></canvas>
                </div>
            </div>
            
            <!-- Physics Analysis -->
            <div class="chart-panel">
                <div class="panel-header">
                    <h3 class="panel-title">🔬 Physics Analysis</h3>
                </div>
                <div class="panel-content">
                    <div class="analysis-results" id="analysis-results">
                        Physics analysis will appear here when logging is active...
                    </div>
                    <div>
                        <button class="btn btn-primary" onclick="performPhysicsAnalysis()">🔍 Analyze Now</button>
                        <button class="btn btn-purple" onclick="exportAnalysisReport()">📋 Export Report</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Parameter Summary -->
        <div class="panel full-width">
            <div class="panel-header">
                <h2 class="panel-title">
                    <span>📋</span>
                    Current Parameter Summary
                </h2>
            </div>
            <div class="panel-content">
                <div id="parameter-summary" class="parameter-summary">
                    <!-- Parameter summary will be populated here -->
                </div>
            </div>
        </div>
    </main>

    <script>
        // Connection status handling
        function updateConnectionStatus(connected) {
            const statusElement = document.getElementById('connection-status');
            const indicator = statusElement.querySelector('.status-indicator');
            const text = statusElement.querySelector('span:last-child');
            
            if (connected) {
                statusElement.className = 'status-badge status-online';
                text.textContent = 'ROS Connected';
            } else {
                statusElement.className = 'status-badge status-offline';
                text.textContent = 'ROS Offline';
            }
        }

        // ROS connection
        var ros = new ROSLIB.Ros({
            url: 'ws://' + window.location.hostname + ':9090'
        });
        
        // Physics data storage
        var physicsData = [];
        var isLogging = false;
        var startTime = Date.now();
        var lastPosition = {x: 0, y: 0};
        var lastVelocity = {linear: 0, angular: 0};
        var physicsStepCount = 0;
        
        // Connection status handling
        ros.on('connection', function() {
            console.log('Connected to ROS!');
            updateConnectionStatus(true);
            setTimeout(readParametersFromServer, 1000);
        });
        
        ros.on('error', function(error) {
            console.log('ROS connection error: ', error);
            updateConnectionStatus(false);
        });
        
        ros.on('close', function() {
            console.log('ROS connection closed');
            updateConnectionStatus(false);
        });
        
        // Current physics parameters
        var physicsParams = {
            maxLinearVel: 0.5,
            maxAngularVel: 1.0,
            accelerationLimit: 1.0,
            robotMass: 15,
            frictionCoeff: 1.0,
            dampingFactor: 0.2
        };
        
        // ROS topics
        var cmdVel = new ROSLIB.Topic({
            ros: ros,
            name: '/cmd_vel',
            messageType: 'geometry_msgs/Twist'
        });
        
        var odomSubscriber = new ROSLIB.Topic({
            ros: ros,
            name: '/odom',
            messageType: 'nav_msgs/Odometry'
        });
        
        // Chart setup
        var trajectoryChart = new Chart(document.getElementById('trajectoryChart'), {
            type: 'scatter',
            data: {
                datasets: [{
                    label: 'Robot Path',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                    showLine: true,
                    pointRadius: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'X Position (m)' }},
                    y: { title: { display: true, text: 'Y Position (m)' }}
                }
            }
        });
        
        var velocityChart = new Chart(document.getElementById('velocityChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Linear Velocity',
                    data: [],
                    borderColor: 'rgb(255, 99, 132)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)',
                    fill: false
                }, {
                    label: 'Angular Velocity',
                    data: [],
                    borderColor: 'rgb(54, 162, 235)',
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Time (s)' }},
                    y: { title: { display: true, text: 'Velocity' }}
                }
            }
        });
        
        var energyChart = new Chart(document.getElementById('energyChart'), {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Kinetic Energy (J)',
                    data: [],
                    borderColor: 'rgb(153, 102, 255)',
                    backgroundColor: 'rgba(153, 102, 255, 0.2)',
                    fill: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { title: { display: true, text: 'Time (s)' }},
                    y: { title: { display: true, text: 'Energy (J)' }}
                }
            }
        });
        
        // Monitor robot state and log data
        odomSubscriber.subscribe(function(message) {
            try {
                var currentTime = (Date.now() - startTime) / 1000;
                physicsStepCount++;
                
                // Extract physics data
                var position = {
                    x: message.pose.pose.position.x,
                    y: message.pose.pose.position.y
                };
                
                var linearVel = Math.sqrt(
                    Math.pow(message.twist.twist.linear.x, 2) + 
                    Math.pow(message.twist.twist.linear.y, 2)
                );
                var angularVel = Math.abs(message.twist.twist.angular.z);
                
                // Calculate physics metrics
                var kineticEnergy = 0.5 * physicsParams.robotMass * (linearVel * linearVel);
                
                // Calculate acceleration
                var acceleration = 0;
                if (physicsData.length > 0) {
                    var lastData = physicsData[physicsData.length - 1];
                    var dt = currentTime - lastData.time;
                    if (dt > 0) {
                        acceleration = (linearVel - lastData.velocity) / dt;
                    }
                }
                
                // Update real-time display
                document.getElementById('current-x').textContent = position.x.toFixed(3);
                document.getElementById('current-y').textContent = position.y.toFixed(3);
                document.getElementById('current-linear').textContent = linearVel.toFixed(3);
                document.getElementById('current-angular').textContent = angularVel.toFixed(3);
                document.getElementById('kinetic-energy').textContent = kineticEnergy.toFixed(2);
                document.getElementById('acceleration').textContent = acceleration.toFixed(3);
                
                // Store data if logging
                if (isLogging) {
                    var dataPoint = {
                        time: currentTime,
                        position_x: position.x,
                        position_y: position.y,
                        velocity: linearVel,
                        angular_velocity: angularVel,
                        acceleration: acceleration,
                        kinetic_energy: kineticEnergy,
                        physics_step: physicsStepCount
                    };
                    
                    physicsData.push(dataPoint);
                    document.getElementById('data-count').textContent = physicsData.length;
                    
                    // Update charts
                    updatePhysicsCharts();
                    
                    // Physics analysis every 20 data points
                    if (physicsData.length % 20 === 0) {
                        performPhysicsAnalysis();
                    }
                }
                
                lastPosition = position;
                lastVelocity = {linear: linearVel, angular: angularVel};
                
            } catch (e) {
                console.log('Error processing odometry:', e);
            }
        });
        
        function updateParameter(paramId) {
            var slider = document.getElementById(paramId);
            var valueDisplay = document.getElementById(paramId + '-value');
            var value = parseFloat(slider.value);
            
            valueDisplay.textContent = value.toFixed(2);
            
            // Update internal parameters
            switch(paramId) {
                case 'max-linear-vel':
                    physicsParams.maxLinearVel = value;
                    break;
                case 'max-angular-vel':
                    physicsParams.maxAngularVel = value;
                    break;
                case 'acceleration-limit':
                    physicsParams.accelerationLimit = value;
                    break;
                case 'robot-mass':
                    physicsParams.robotMass = value;
                    break;
                case 'friction-coeff':
                    physicsParams.frictionCoeff = value;
                    break;
                case 'damping-factor':
                    physicsParams.dampingFactor = value;
                    break;
            }
            
            updateParameterSummary();
            console.log('Updated parameter:', paramId, '=', value);
        }
        
        function updateParameterSummary() {
            var summary = `
Robot Physics Parameters:
├─ Motion
│  ├─ Max Linear Velocity: ${physicsParams.maxLinearVel} m/s
│  ├─ Max Angular Velocity: ${physicsParams.maxAngularVel} rad/s
│  └─ Acceleration Limit: ${physicsParams.accelerationLimit} m/s²
│
└─ Physics
   ├─ Mass: ${physicsParams.robotMass} kg
   ├─ Wheel Friction: ${physicsParams.frictionCoeff}
   └─ Damping Factor: ${physicsParams.dampingFactor}
            `.trim();
            
            document.getElementById('parameter-summary').textContent = summary;
        }
        
        function startLogging() {
            isLogging = true;
            physicsData = [];
            startTime = Date.now();
            physicsStepCount = 0;
            document.getElementById('logging-status').textContent = 'Recording';
            document.getElementById('logging-status').style.color = 'var(--success-green)';
            addAnalysisResult('Physics data logging started');
        }
        
        function stopLogging() {
            isLogging = false;
            document.getElementById('logging-status').textContent = 'Stopped';
            document.getElementById('logging-status').style.color = 'var(--error-red)';
            addAnalysisResult(`Logging stopped. ${physicsData.length} data points collected.`);
        }
        
        function updatePhysicsCharts() {
            if (physicsData.length === 0) return;
            
            // Update trajectory chart (last 100 points)
            var trajectoryData = physicsData.slice(-100).map(d => ({x: d.position_x, y: d.position_y}));
            trajectoryChart.data.datasets[0].data = trajectoryData;
            trajectoryChart.update('none');
            
            // Update velocity chart (last 50 points)
            var recentData = physicsData.slice(-50);
            velocityChart.data.labels = recentData.map(d => d.time.toFixed(1));
            velocityChart.data.datasets[0].data = recentData.map(d => d.velocity);
            velocityChart.data.datasets[1].data = recentData.map(d => d.angular_velocity);
            velocityChart.update('none');
            
            // Update energy chart
            energyChart.data.labels = recentData.map(d => d.time.toFixed(1));
            energyChart.data.datasets[0].data = recentData.map(d => d.kinetic_energy);
            energyChart.update('none');
        }
        
        function performPhysicsAnalysis() {
            if (physicsData.length < 10) return;
            
            var recent = physicsData.slice(-10);
            var avgVelocity = recent.reduce((sum, d) => sum + d.velocity, 0) / recent.length;
            var maxVelocity = Math.max(...recent.map(d => d.velocity));
            var energyVariation = Math.max(...recent.map(d => d.kinetic_energy)) - 
                                 Math.min(...recent.map(d => d.kinetic_energy));
            
            // Check for physics anomalies
            if (maxVelocity > physicsParams.maxLinearVel * 1.1) {
                addAnalysisResult('⚠️ Velocity exceeds limit: ' + maxVelocity.toFixed(2) + ' m/s');
            }
            
            if (energyVariation > 20) {
                addAnalysisResult('⚠️ Large energy variation: ' + energyVariation.toFixed(2) + ' J');
            }
            
            // Physics validation
            var expectedKE = 0.5 * physicsParams.robotMass * avgVelocity * avgVelocity;
            var actualKE = recent[recent.length-1].kinetic_energy;
            var error = Math.abs(expectedKE - actualKE) / Math.max(expectedKE, 0.001) * 100;
            
            if (error > 5) {
                addAnalysisResult('⚠️ Physics error: ' + error.toFixed(1) + '%');
            } else {
                addAnalysisResult('✓ Physics validation OK (error: ' + error.toFixed(1) + '%)');
            }
        }
        
        function addAnalysisResult(message) {
            var timestamp = new Date().toLocaleTimeString();
            var resultsDiv = document.getElementById('analysis-results');
            resultsDiv.textContent += `[${timestamp}] ${message}\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
            
            // Keep only last 20 lines
            var lines = resultsDiv.textContent.split('\n');
            if (lines.length > 20) {
                resultsDiv.textContent = lines.slice(-20).join('\n');
            }
        }
        
        function exportPhysicsData() {
            if (physicsData.length === 0) {
                alert('No physics data to export. Start logging first.');
                return;
            }
            
            var csvContent = "time,position_x,position_y,velocity,angular_velocity,acceleration,kinetic_energy,physics_step\n";
            physicsData.forEach(function(d) {
                csvContent += `${d.time},${d.position_x},${d.position_y},${d.velocity},${d.angular_velocity},${d.acceleration},${d.kinetic_energy},${d.physics_step}\n`;
            });
            
            downloadCSV(csvContent, 'physics_tuning_data.csv');
            addAnalysisResult(`Data exported: ${physicsData.length} points`);
        }
        
        function exportAnalysisReport() {
            var reportContent = "Physics Analysis Report\n";
            reportContent += "Generated: " + new Date().toLocaleString() + "\n\n";
            reportContent += "Current Parameters:\n";
            reportContent += Object.keys(physicsParams).map(key => 
                `${key}: ${physicsParams[key]}`).join('\n');
            reportContent += "\n\nAnalysis Log:\n";
            reportContent += document.getElementById('analysis-results').textContent;
            
            downloadCSV(reportContent, 'physics_analysis_report.txt');
        }
        
        function downloadCSV(content, filename) {
            var blob = new Blob([content], { type: 'text/plain' });
            var url = window.URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', filename);
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        function clearLogs() {
            physicsData = [];
            trajectoryChart.data.datasets[0].data = [];
            velocityChart.data.labels = [];
            velocityChart.data.datasets[0].data = [];
            velocityChart.data.datasets[1].data = [];
            energyChart.data.labels = [];
            energyChart.data.datasets[0].data = [];
            
            trajectoryChart.update();
            velocityChart.update();
            energyChart.update();
            
            document.getElementById('data-count').textContent = '0';
            document.getElementById('analysis-results').textContent = 'Physics analysis cleared...\n';
            addAnalysisResult('Data logs cleared');
        }
        
        // Original physics tuner functions
        function publishAllParameters() {
            addTestResult('Publishing all parameters to ROS Parameter Server...');
            
            var params = [
                {name: '/robot/max_linear_velocity', value: physicsParams.maxLinearVel},
                {name: '/robot/max_angular_velocity', value: physicsParams.maxAngularVel},
                {name: '/robot/acceleration_limit', value: physicsParams.accelerationLimit},
                {name: '/robot/mass', value: physicsParams.robotMass},
                {name: '/robot/wheel_friction', value: physicsParams.frictionCoeff},
                {name: '/robot/damping_factor', value: physicsParams.dampingFactor}
            ];
            
            var publishCount = 0;
            var totalParams = params.length;
            
            params.forEach(function(param) {
                var rosParam = new ROSLIB.Param({
                    ros: ros,
                    name: param.name
                });
                
                rosParam.set(param.value, function(result) {
                    publishCount++;
                    console.log('Published parameter:', param.name, '=', param.value);
                    
                    if (publishCount === totalParams) {
                        addTestResult(`✅ Successfully published ${totalParams} parameters to ROS`);
                        document.getElementById('param-status').innerHTML = 
                            '<small style="color: var(--success-green);"><em>✅ Parameters published to ROS Parameter Server</em></small>';
                    }
                });
            });
        }
        
        function readParametersFromServer() {
            addTestResult('Reading parameters from ROS Parameter Server...');
            
            var params = [
                {name: '/robot/max_linear_velocity', id: 'max-linear-vel'},
                {name: '/robot/max_angular_velocity', id: 'max-angular-vel'},
                {name: '/robot/acceleration_limit', id: 'acceleration-limit'},
                {name: '/robot/mass', id: 'robot-mass'},
                {name: '/robot/wheel_friction', id: 'friction-coeff'},
                {name: '/robot/damping_factor', id: 'damping-factor'}
            ];
            
            var readCount = 0;
            var foundParams = 0;
            
            params.forEach(function(param) {
                var rosParam = new ROSLIB.Param({
                    ros: ros,
                    name: param.name
                });
                
                rosParam.get(function(value) {
                    readCount++;
                    if (value !== null && value !== undefined) {
                        foundParams++;
                        document.getElementById(param.id).value = value;
                        updateParameter(param.id);
                    }
                    
                    if (readCount === params.length) {
                        if (foundParams > 0) {
                            addTestResult(`✅ Read ${foundParams} parameters from ROS`);
                        } else {
                            addTestResult('⚠️ No parameters found on ROS Parameter Server');
                        }
                    }
                }, function(error) {
                    readCount++;
                    if (readCount === params.length) {
                        addTestResult('⚠️ Some parameters not found on server');
                    }
                });
            });
        }
        
        function testLinearMovement() {
            addTestResult(`Testing linear movement at ${physicsParams.maxLinearVel} m/s...`);
            
            var twist = new ROSLIB.Message({
                linear: { x: physicsParams.maxLinearVel, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: 0 }
            });
            cmdVel.publish(twist);
            
            setTimeout(function() {
                stopRobot();
                addTestResult(`✅ Linear test complete. Max velocity: ${physicsParams.maxLinearVel} m/s`);
            }, 3000);
        }
        
        function testAngularMovement() {
            addTestResult(`Testing angular movement at ${physicsParams.maxAngularVel} rad/s...`);
            
            var twist = new ROSLIB.Message({
                linear: { x: 0, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: physicsParams.maxAngularVel }
            });
            cmdVel.publish(twist);
            
            setTimeout(function() {
                stopRobot();
                addTestResult(`✅ Angular test complete. Max angular velocity: ${physicsParams.maxAngularVel} rad/s`);
            }, 2000);
        }
        
        function testAcceleration() {
            addTestResult('Testing acceleration profile...');
            
            var targetVel = physicsParams.maxLinearVel;
            var accelLimit = physicsParams.accelerationLimit;
            var timeToTarget = targetVel / accelLimit;
            var steps = 20;
            var stepTime = (timeToTarget * 1000) / steps;
            var velIncrement = targetVel / steps;
            
            var currentVel = 0;
            var step = 0;
            
            var accelInterval = setInterval(function() {
                currentVel = Math.min(currentVel + velIncrement, targetVel);
                
                var twist = new ROSLIB.Message({
                    linear: { x: currentVel, y: 0, z: 0 },
                    angular: { x: 0, y: 0, z: 0 }
                });
                cmdVel.publish(twist);
                
                step++;
                if (step >= steps) {
                    clearInterval(accelInterval);
                    setTimeout(function() {
                        stopRobot();
                        addTestResult(`✅ Acceleration test complete. Time to max speed: ${timeToTarget.toFixed(1)}s`);
                    }, 1000);
                }
            }, stepTime);
        }
        
        function testDeceleration() {
            addTestResult('Testing deceleration and stopping...');
            
            var twist = new ROSLIB.Message({
                linear: { x: physicsParams.maxLinearVel, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: 0 }
            });
            cmdVel.publish(twist);
            
            setTimeout(function() {
                stopRobot();
                var stoppingTime = physicsParams.maxLinearVel / physicsParams.accelerationLimit;
                var dampingEffect = (1 - physicsParams.dampingFactor) * 2;
                var totalStopTime = stoppingTime + dampingEffect;
                
                addTestResult(`✅ Deceleration test complete. Estimated stopping time: ${totalStopTime.toFixed(1)}s`);
            }, 1500);
        }
        
        function emergencyStop() {
            stopRobot();
            addTestResult('🚨 Emergency stop activated');
        }
        
        function resetToDefaults() {
            document.getElementById('max-linear-vel').value = 0.5;
            document.getElementById('max-angular-vel').value = 1.0;
            document.getElementById('acceleration-limit').value = 1.0;
            document.getElementById('robot-mass').value = 15;
            document.getElementById('friction-coeff').value = 1.0;
            document.getElementById('damping-factor').value = 0.2;
            
            ['max-linear-vel', 'max-angular-vel', 'acceleration-limit', 
             'robot-mass', 'friction-coeff', 'damping-factor'].forEach(function(id) {
                updateParameter(id);
            });
            
            addTestResult('Parameters reset to default values');
        }
        
        function stopRobot() {
            var twist = new ROSLIB.Message({
                linear: { x: 0, y: 0, z: 0 },
                angular: { x: 0, y: 0, z: 0 }
            });
            cmdVel.publish(twist);
        }
        
        function addTestResult(message) {
            var resultsDiv = document.getElementById('test-results');
            var timestamp = new Date().toLocaleTimeString();
            var resultElement = document.createElement('div');
            resultElement.className = 'physics-result';
            resultElement.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            resultsDiv.appendChild(resultElement);
            
            // Keep only last 5 results
            while (resultsDiv.children.length > 5) {
                resultsDiv.removeChild(resultsDiv.firstChild);
            }
            
            // Also add to analysis log
            addAnalysisResult(message);
        }
        
        // Navigation functionality
        function updateNavigation() {
            const currentPath = window.location.pathname;
            const navLinks = document.querySelectorAll('.nav-link');
            
            navLinks.forEach(link => {
                const href = link.getAttribute('href');
                const isActive = (currentPath === href) || 
                            (currentPath === '/' && href === '/') ||
                            (currentPath.includes(href) && href !== '/');
                
                if (isActive) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            updateNavigation();
            
            // Initialize all parameter displays
            ['max-linear-vel', 'max-angular-vel', 'acceleration-limit', 
             'robot-mass', 'friction-coeff', 'damping-factor'].forEach(function(id) {
                updateParameter(id);
            });
            
            // Initialize parameter summary
            updateParameterSummary();
            
            // Initialize analysis
            addAnalysisResult('Enhanced Physics Tuner initialized');
            
            console.log('🚀 Corporate Physics Parameter Tuner loaded');
        });

        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden) {
                updateNavigation();
            }
        });
    </script>
</body>
</html>